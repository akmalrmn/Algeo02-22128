<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Gallery</title>
</head>
<body>
    <h1>Image Gallery</h1>
    
    <div id="upload-image-container"></div>
    
    <button id="test_button" onclick="forceload()"> TESTA </button>

    <br>
    <!-- File input button -->
    <label for="fileInput" class="input-image-label">Choose Images</label>
    <input type="file" id="fileInput" onchange="uploadSearchImage()" accept="image/*" style="display:none;">

    <br>
    <br>
    <br>

    <label for="datasetInput" class="input-dataset-label">Choose Dataset</label>
    <input type="file" id="datasetInput" onchange="uploadDatasetImage()" accept="image/*" multiple style="display:none;">
    
    
    
    

    <div id="image-container"></div>
    
    <div id="pagination-container">
        <button id="prevPageButton">Previous Page</button>
        <span id="pageIndicator">Page 1</span>
        <button id="nextPageButton">Next Page</button>
    </div>

    <script>
    let mode = "TEKSTUR"
    let currentPage = 1;
    let fileUploaded = false;
    let datasetUploaded = false;
    let maxPage = 1;

    async function displayUpload() {
    const response = await fetch(`/display_upload`);
    const data = await response.json();

    const imageContainer = document.getElementById('upload-image-container');
    imageContainer.innerHTML = '';  // Clear existing images

    if (data.image) {
        const imgElement = document.createElement('img');
        imgElement.src = data.image;
        imgElement.style.maxWidth = '300px';
        imgElement.style.margin = '10px';
        imageContainer.appendChild(imgElement);
    }
}

    async function swap_mode(){
        if (mode == "TEKSTUR"){
            mode = "WARNA";
        }
        else if (mode == "WARNA"){
            mode = "TEKSTUR";
        }
    }
    async function fetchImages(page) {
        const response = await fetch(`/get_images?page=${page}&mode=${mode}`);
        const data = await response.json();

        console.log("mode :",mode);

        const imageContainer = document.getElementById('image-container');
        imageContainer.innerHTML = '';  // Clear existing images

        maxPage = data.maxPage
        data.images.forEach(image => {
            const imgElement = document.createElement('img');
            imgElement.src = image.url;
            imgElement.style.maxWidth = '300px';
            imgElement.style.margin = '10px';
            imageContainer.appendChild(imgElement);
        });

        // Update the page indicator
        const pageIndicator = document.getElementById('pageIndicator');
        pageIndicator.textContent = `Page ${page}`;
    }

    function uploadSearchImage() {
        const fileInput = document.getElementById('fileInput');
        const files = fileInput.files;

        if (files.length > 0) {
            const formData = new FormData();

            for (const file of files) {
                formData.append('files', file);
            }
            fileUploaded = true
            fetch(`/upload_search`, {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                    fileUploaded = true;
                    displayUpload();
                    console.log('Search file uploaded:', data.filenames);
            })
            .catch(error => {
                console.error('Error uploading files:', error);
            });
        }

        if (datasetUploaded && fileUploaded){
            fetchImages(1);
        }

    }

    function test_ping(){
        fetch(`/test_ping`);
        console.log("Ping");
    }
    
    function uploadDatasetImage() {
        const fileInput = document.getElementById('datasetInput');
        const files = fileInput.files;

        if (files.length > 0) {
            const formData = new FormData();

            for (const file of files) {
                formData.append('files', file);
            }

            datasetUploaded = true

            fetch(`/upload_dataset`, {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                    datasetUploaded = true;
                    console.log('Dataset uploaded:', data.filenames);

                    //after uploading dataset, attempt to calculate images
            })
            .catch(error => {
                console.error('Error uploading dataset files:', error);
            });
        }
        
        if (datasetUploaded && fileUploaded){
            fetchImages(1);
        }
        
    }

    function forceload(){
        fetch('/force_load');
        displayUpload();
        fileUploaded = true;
        datasetUploaded - true;
        fetchImages(1);
    }

    const prevPageButton = document.getElementById('prevPageButton');
    const nextPageButton = document.getElementById('nextPageButton');
    const imageUploadButton = document.getElementById('uploadImageButton');
    const datasetUploadButton = document.getElementById('datasetImageButton');

    imageUploadButton.addEventListener('click',() => {

    })


    prevPageButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            fetchImages(currentPage);
        }
    });

    nextPageButton.addEventListener('click', () => {
        if (currentPage < maxPage) {
            currentPage++;
            fetchImages(currentPage);
        }
    });
    </script>
</body>
</html>
